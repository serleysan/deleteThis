&НаКлиенте
Процедура ИмяФайлаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	Оповещение = Новый ОписаниеОповещения("ОбработатьВыборФайла", ЭтотОбъект);
	НачатьПомещениеФайла(Оповещение, , , Истина, УникальныйИдентификатор);
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыборФайла(Результат, Адрес, ВыбранноеИмяФайла, ДополнительныеПараметры) Экспорт
	Если Не Результат Тогда
		Возврат;
	КонецЕсли;
	ИмяФайла = ВыбранноеИмяФайла;
КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	СформироватьНаСервере(ИмяФайла);
КонецПроцедуры

&НаСервере
Процедура СформироватьНаСервере(ИмяФайла)
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.Прочитать(ИмяФайла, СпособЧтенияЗначенийТабличногоДокумента.Значение);
	ПостроительЗапроса = Новый ПостроительЗапроса;
	ПостроительЗапроса.ИсточникДанных = Новый ОписаниеИсточникаДанных(ТабДок.Область("Лист1"));
	ПостроительЗапроса.Выполнить();
	ТЗ = ПостроительЗапроса.Результат.Выгрузить();
	ЧислоСтрок = ТЗ.Количество();
	
	Для Строка = 0 По ЧислоСтрок - 1 Цикл
		Мас = ТЗ[Строка];
		ДатаРождения = Мас.ДатаРождения;
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	Сотрудники.Ссылка КАК Сотрудник
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.Наименование = &Наименование
		|	И Сотрудники.ДатаРождения = &ДатаРождения";
		
		Запрос.УстановитьПараметр("Наименование", Мас.ФИО);
		Запрос.УстановитьПараметр("ДатаРождения", ДатаРождения);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Сотрудник = Выборка.Сотрудник;
		Иначе
			Сотрудник = Справочники.Сотрудники.СоздатьЭлемент();
			Сотрудник.Наименование = Мас.Имя;
			Сотрудник.ДатаРождения = ДатаРождения;
			мФИО = СтрРазделить(Мас.ФИО, " ");
			Сотрудник.ФИО = мФИО[0] + " " + мФИО[1] + " " + мФИО[2];
			Сотрудник.Записать();
			Сообщить(Сотрудник);
		КонецЕсли;
		
		Запрос = Новый Запрос; 
		Запрос.Текст =
		"ВЫБРАТЬ
		|	СотрудникиСрезПоследних.Сотрудник КАК Сотрудник 
		|ИЗ
		|	РегистрСведений.Сотрудники.СрезПоследних(
		|			,
		|			Сотрудник = &Сотрудник
		|				И Период = &Дата) КАК СотрудникиСрезПоследних";
		
		Запрос.УстановитьПараметр("Дата", Дата);
		Запрос.УстановитьПараметр("Сотрудник", Сотрудник.Ссылка);
		Результат = Запрос.Выполнить();
		Если Не Результат.Пустой() Тогда
			Продолжить;
		КонецЕсли;
		СведенияОСотруднике = РегистрыСведений.Сотрудники.СоздатьМенеджерЗаписи();
		СведенияОСотруднике.Период = Дата;
		СведенияОСотруднике.Сотрудник = Сотрудник.Ссылка;
		СведенияОСотруднике.Организация = Справочники.Организации.НайтиПоНаименованию(Мас.Организация);
		СведенияОСотруднике.Должность = Справочники.Должности.НайтиПоНаименованию(Мас.Должность);
		СведенияОСотруднике.Записать();
	КонецЦикла;
	
КонецПроцедуры


