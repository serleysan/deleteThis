
&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	Запрос = Новый Запрос; 
	 Запрос.Текст = "ВЫБРАТЬ
					 |	Пользователи.Логин КАК Логин,
					 |	Пользователи.УникальныйИдентификатор КАК УникальныйИдентификатор
					 |ИЗ
					 |	Справочник.Пользователи КАК Пользователи
					 |ГДЕ
					 |	Пользователи.Логин = &Логин";
	 Запрос.УстановитьПараметр("Логин", Объект.Логин);
	 Результат = Запрос.Выполнить().Выбрать();     
	 
	 Если Результат.Следующий() тогда
		 Если Результат.Количество() = 0 ИЛИ ТекущийОбъект.УникальныйИдентификатор = Результат.УникальныйИдентификатор тогда
			 ПользовательСсылка = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(ТекущийОбъект.УникальныйИдентификаитор);
			 
			 Если ПользовательСсылка = Неопределено тогда
				 НовыйПользователь = ПользователиИнформационнойБазы.СоздатьПользователя();   
				 НовыйПользователь.Имя = Объект.Логин; 
				 НовыйПользователь.Пароль = Объект.Пароль;  
				 НовыйПользователь.ПолноеИмя = Объект.Наименование;   
				 Если Объект.Роль = Перечисления.Роли.Администратор тогда 
					 НовыйПользователь.Роли.Добавить(Метаданные.Роли.Администратор);    
				 ИначеЕсли Объект.Роль = Перечисления.Роли.Библиотекарь тогда   
					 НовыйПользователь.Роли.Добавить(Метаданные.Роли.Библиотекарь);
				 ИначеЕсли Объект.Роль = Перечисления.Роли.Бухгалтер тогда 
					 НовыйПользователь.Роли.Добавить(Метаданные.Роли.Бухгалтер);   
				 КонецЕсли;
				 НовыйПользователь.ПоказыватьВСпискеВыбора = Ложь;
				 НовыйПользователь.Записать();
				 ТекущийОбъект.УникальныйИдентификатор = НовыйПользователь.УникальныйИдентификатор; 
			 Иначе  
				 ПользовательСсылка.Пароль = Объект.Пароль;
				 ПользовательСсылка.ПолноеИмя = Объект.Наименование;
				 ПользовательСсылка.Роли.Очистить();
				 Если Объект.Роль = Перечисления.Роли.Администратор тогда 
					 НовыйПользователь.Роли.Добавить(Метаданные.Роли.Администратор);    
				 ИначеЕсли Объект.Роль = Перечисления.Роли.Библиотекарь тогда   
					 НовыйПользователь.Роли.Добавить(Метаданные.Роли.Библиотекарь);
				 ИначеЕсли Объект.Роль = Перечисления.Роли.Бухгалтер тогда 
					 НовыйПользователь.Роли.Добавить(Метаданные.Роли.Бухгалтер);   
				 КонецЕсли; 
				 ПользовательСсылка.Записать();
				КонецЕсли;
			 Иначе
				 Сообщ = Новый СообщениеПользователю;
				 Сообщ.Текст = "Пользователь с таким логином уже существует";
				 Сообщ.Сообщить();
				 Отказ = Истина;
			 КонецЕсли;
		 Иначе
			 НовыйПользователь = ПользователиИнформационнойБазы.СоздатьПользователя();
			 		НовыйПользователь.Имя = Объект.Логин;
					НовыйПользователь.Пароль = Объект.Пароль;
					НовыйПользователь.ПолноеИмя = Объект.Наименование; 
					Если Объект.Роль = Перечисления.Роли.Администратор тогда 
					 	НовыйПользователь.Роли.Добавить(Метаданные.Роли.Администратор);    
				 	ИначеЕсли Объект.Роль = Перечисления.Роли.Библиотекарь тогда   
					 	НовыйПользователь.Роли.Добавить(Метаданные.Роли.Библиотекарь);
				 	ИначеЕсли Объект.Роль = Перечисления.Роли.Бухгалтер тогда 
					 	НовыйПользователь.Роли.Добавить(Метаданные.Роли.Бухгалтер);   
				 	КонецЕсли;
					НовыйПользователь.ПоказыватьВСпискеВыбора = Ложь;
					НовыйПользователь.Записать();
					ТекущийОбъект.УникальныйИдентификатор = НовыйПользователь.УникальныйИдентификатор;
			КонецЕсли;
КонецПроцедуры
