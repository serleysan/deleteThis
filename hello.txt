
&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	Пользователи.Логин КАК Логин,
	               |	Пользователи.УникальныйИдентификатор КАК УникальныйИдентификатор
	               |ИЗ
	               |	Справочник.Пользователи КАК Пользователи
	               |ГДЕ
	               |	Пользователи.Логин = &Логин";
	Запрос.УстановитьПараметр("Логин", Объект.Логин);
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() И Результат.УникальныйИдентификатор <> ТекущийОбъект.УникальныйИдентификатор Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Пользователь с таким логином уже существует.";
		Сообщение.Сообщить();
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(ТекущийОбъект.УникальныйИдентификатор);
	
	Если ПользовательИБ = Неопределено Тогда
		ПользовательИБ = ПользователиИнформационнойБазы.СоздатьПользователя();
	КонецЕсли;
	
	ПользовательИБ.Имя = ТекущийОбъект.Логин;
	ПользовательИБ.ПолноеИмя = ТекущийОбъект.Наименование;
	ПользовательИБ.Роли.Очистить();
	
	ВыбраннаяРоль = Неопределено;
	Если ТекущийОбъект.Роль = Перечисления.Роли.Администратор Тогда
		ВыбраннаяРоль = Метаданные.Роли.Администратор;
	ИначеЕсли ТекущийОбъект.Роль = Перечисления.Роли.Риелтор Тогда
		ВыбраннаяРоль = Метаданные.Роли.Риелтор;
	ИначеЕсли ТекущийОбъект.Роль = Перечисления.Роли.Юрист Тогда
		ВыбраннаяРоль = Метаданные.Роли.Юрист;
	КонецЕсли;
	
	Если ВыбраннаяРоль <> Неопределено Тогда
		ПользовательИБ.Роли.Добавить(ВыбраннаяРоль);
	КонецЕсли;
	ПользовательИБ.ПоказыватьВСпискеВыбора = Ложь;
	ПользовательИБ.Записать();
	
	ТекущийОбъект.УникальныйИдентификатор = ПользовательИб.УникальныйИдентификатор;  
	Если ТекущийОбъект.СтатусПользователя = Перечисления.СтатусыПользователей.Уволен Тогда
		
		Если ПользовательИБ <> Неопределено Тогда
			ПользовательИБ.Удалить();
			ТекущийОбъект.УникальныйИдентификатор = Неопределено;
		КонецЕсли;

	КонецЕсли;
КонецПроцедуры
